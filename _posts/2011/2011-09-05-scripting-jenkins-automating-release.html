---
layout: post
title: 'Scripting Jenkins: Automating the Release Cycle'
date: '2011-09-05T20:48:00.000+02:00'
author: martin
tags:
- devops
- CI
- jenkins
- groovy
modified_time: '2012-04-16T15:01:41.050+02:00'
blogger_id: tag:blogger.com,1999:blog-987786588703208935.post-781154041645032984
blogger_orig_url: http://bxm-dev.blogspot.com/2011/09/scripting-jenkins-automating-release.html
category: dev
---

At any point of time, we have (at least) three different codebases of interest:<br /><ul><li>TRUNK - For developing new features</li><li>BRANCH “x-1″ - The most recent release (which is still in QA)</li><li>BRANCH “x-2″ - The current production release</li></ul>The CI-jobs (unit tests, integration tests etc) must run for each codebase, and each codebase should maintain its own history.<br />So, right now each (2-week) development cycle includes the following steps:<br /><ol><li>disable all Jenkins-jobs for BRANCH “x-2″ (because release “x-1″ became productive)</li><li>create BRANCH “x” (i.e. the new release-branch for QA) from TRUNK</li><li>copy all “x-1″ Jenkins-jobs to “x”</li><li>modify all new “x” jobs to access the correct branch</li></ol>For #2, we are using the <a href="https://wiki.jenkins-ci.org/display/JENKINS/Subversion+Tagging+Plugin">Subversion Tagging Plugin</a>, but all other steps are performed manually.<br />Solution: Write a <a href="https://wiki.jenkins-ci.org/display/JENKINS/Jenkins+Script+Console">Groovy script</a> and execute it with the <a href="https://wiki.jenkins-ci.org/display/JENKINS/Jenkins+CLI">Commandline Client</a>:<br /><pre class="brush:xml">import hudson.model.*<br />import hudson.scm.*<br />import org.tmatesoft.svn.core.*<br />import org.tmatesoft.svn.core.auth.*<br />import org.tmatesoft.svn.core.wc.*<br />&nbsp;<br />sprint = "SPRINT"<br />jenkins = Hudson.instance<br />sprintJobs = jenkins.items.findAll{job -&gt; job.name.indexOf(sprint) &gt;= 0}<br />&nbsp;<br />// find out the number of the current sprint:<br />thisSprint = 0<br />sprintJobs.each { job -&gt;<br />&nbsp;&nbsp;pos = job.name.indexOf(sprint) + sprint.length()<br />&nbsp;&nbsp;// TODO handle NumberFormatException<br />&nbsp;&nbsp;// TODO handle different number length<br />&nbsp;&nbsp;jobSprint = job.name.substring(pos, pos + 2) as int<br />&nbsp;&nbsp;thisSprint = Math.max(thisSprint, jobSprint)<br />}<br />prevSprint = thisSprint - 1<br />nextSprint = thisSprint + 1<br />println("*********************\n* Closing Sprint " + nextSprint + " *\n*********************")<br />&nbsp;<br />// disable all jobs for the last sprint:<br />sprintJobs.findAll{job -&gt; job.name.indexOf(sprint + prevSprint) &gt;= 0}.each { job -&gt;<br />&nbsp;&nbsp;println("Disabling " + job.name)<br />&nbsp;&nbsp;job.disabled = true<br />&nbsp;&nbsp;job.save()<br />}<br />&nbsp;<br />// create branch (based on the given SCM location and the nextSprint value):<br />if (args.length &gt; 0 &amp;&amp; args[0].indexOf("/trunk/") &gt; 0) {<br />&nbsp;&nbsp;scmTrunk = args[0]<br />&nbsp;&nbsp;scmBranch = scmTrunk.replaceAll("/trunk/", "/branches/" + sprint + nextSprint + "/")<br />&nbsp;&nbsp;println("Creating branch " + scmBranch + " based on " + scmTrunk)<br />&nbsp;&nbsp;SVNCopyClient svnClient = new SVNCopyClient((ISVNAuthenticationManager)null, null)<br />&nbsp;&nbsp;SVNCommitInfo svnResult = svnClient.doCopy(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[new SVNCopySource(SVNRevision.HEAD, SVNRevision.HEAD, SVNURL.parseURIEncoded(scmTrunk))] as SVNCopySource[],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SVNURL.parseURIEncoded(scmBranch), false, true, true, "Jenkins: Sprint closed, branch created", new SVNProperties())<br />&nbsp;&nbsp;if (svnResult.errorMessage) {<br />&nbsp;&nbsp;&nbsp;&nbsp;println("Branching failed: " + svnResult.fullMessage)<br />&nbsp;&nbsp;} else {<br />&nbsp;&nbsp;&nbsp;&nbsp;println("Branch " + scmBranch + " created at revision " + svnResult.newRevision)<br />&nbsp;&nbsp;}<br />}<br />&nbsp;<br />// copy jobs of the current sprint to the next sprint:<br />sprintJobs.findAll{job -&gt; job.name.indexOf(sprint + thisSprint) &gt;= 0}.each { job -&gt;<br />&nbsp;&nbsp;newName = job.name.replaceAll(sprint + thisSprint, sprint + nextSprint)<br />&nbsp;&nbsp;println("Creating new job " + newName + " based on " + job.name)<br />&nbsp;&nbsp;newJob = jenkins.copy(job, newName)<br />&nbsp;&nbsp;// modify the job parameters to access the correct branch:<br />&nbsp;&nbsp;prop = newJob.getProperty(ParametersDefinitionProperty.class)<br />&nbsp;&nbsp;if (prop) {<br />&nbsp;&nbsp;&nbsp;&nbsp;prop.parameterDefinitions.each{ param -&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (param.defaultValue.startsWith(sprint)) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;println("Changing parameter '" + param.name + "' of job " + newName)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;param.defaultValue = sprint + nextSprint<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;// create modified SCM locations and assign them to the new job:<br />&nbsp;&nbsp;newLocations = []<br />&nbsp;&nbsp;job.scm.locations.each { location -&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;newLocations &lt;&lt; new SubversionSCM.ModuleLocation(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;location.remote.replaceAll(sprint + thisSprint, sprint + nextSprint), location.local)<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;println("Changing SCM locations of job " + newJob.name + ": " + newLocations)<br />&nbsp;&nbsp;newJob.scm = new SubversionSCM(newLocations, job.scm.workspaceUpdater, job.scm.browser, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;job.scm.excludedRegions, job.scm.excludedUsers, job.scm.excludedRevprop, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;job.scm.excludedCommitMessages, job.scm.includedRegions)<br />&nbsp;&nbsp;newJob.save()<br />}</pre>This script disables all jobs with name “SPRINT[x-2]", creates the branch “SPRINT[x]", and copies all jobs with name “SPRINT[x-1]” to “SPRINT[x]", thus modifying the job parameters and the checkout URLs.<br />For executing this script, see my <a href="http://bxm.at/blogs/java/calling-a-jenkins-script-within">next blog entry</a>.<br /><div class="item_footer"><small><a href="http://bxm.at/blogs/java/scripting-jenkins-automating-the-release">Original post</a> blogged on <a href="http://b2evolution.net/">b2evolution</a>.</small></div>