---
layout: post
title: WebAppliction Code Coverage
date: '2006-12-29T08:06:00.000+01:00'
author: martin
tags:
- quality
- testing
modified_time: '2012-04-17T00:13:49.642+02:00'
blogger_id: tag:blogger.com,1999:blog-987786588703208935.post-5381670191651399553
blogger_orig_url: http://bxm-dev.blogspot.com/2006/12/webappliction-code-coverage.html
category: dev
---

<p>The problem is simple:<br />After writing a bunch of JUnit tests for the serverside part of a J2EE Application (and reaching a sufficient code coderage), one would want the same for the WebApp.</p><p>My solution, shortly put:</p><ol>  <li>Instrument the JAR/WAR/EAR file with coverage information</li>  <li>Deploy the instrumented application</li>  <li>Run the (hopefully automated) end-to-end tests</li></ol><p>Luckily, <a href="http://emma.sourceforge.net">EMMA</a> (which is the code coverage tool of my choice) supports analysis <a href="http://emma.sourceforge.net/faq.html#q.runtime.appservers">inside the AppServer</a>.</p><p>So this is how I did it:</p><ol>  <li><p>Instrument the application:<br />This is done in my <a href="http://ant.apache.org">Ant</a> buildscript using the <code>emma instr</code> task. Since EMMA cannot instrument WAR files directly, the first instrumentation step must be performed in the WebApp's buildscript right before packaging the WAR file:</p><blockquote><pre class="brush:xml"><br />&lt;emma&gt;<br />  &lt;instr mode="overwrite" metadatafile="${dir.coverage}/coverage.em" merge="false"&gt;<br />    &lt;instrpath&gt;<br />      &lt;pathelement location="${dir.client.build}/WEB-INF/classes"/&gt;<br />    &lt;/instrpath&gt;<br />  &lt;/instr&gt;<br />&lt;/emma&gt;<br /></pre></blockquote><br /><p>Then, before packaging the EAR file, I instrument the other modules (which in my case all start with "wb") and merge the coverage metadata:</p><br /><blockquote><pre class="brush:xml"><br />&lt;emma&gt;<br />  &lt;instr mode="overwrite" metadatafile="${dir.coverage}/coverage.em" merge="true"&gt;<br />    &lt;instrpath&gt;<br />      &lt;fileset dir="${build.dir}" includes="**/wb*.jar"/&gt;<br />    &lt;/instrpath&gt;<br />  &lt;/instr&gt;<br />&lt;/emma&gt;<br /></pre></blockquote><br />  </li><br />  <li><br />When deploying the EAR file to the AppServer, make sure the <code>emma.jar</code> is in the AppServer's startup classpath<br /><br />  </li><br />  <li><br /><p>Now, anytime you want to make a snapshot of the current code coverage, you can use the <code>emma ctl</code> Ant task.<br /><br />Since I use a two-node cluster, I must fetch the coverage data from each node:</p><br /><blockquote><pre class="brush:xml"><br />&lt;emma&gt;<br />  &lt;ctl connect="node1:47653"&gt;<br />    &lt;!-- dump coverage data, no merge, leaving dump-on-exit enabled: --&gt;<br />    &lt;command name="coverage.get" args="${dir.coverage}/coverage.ec, false, false"/&gt;<br />  &lt;/ctl&gt;<br />  &lt;ctl connect="node1:47653"&gt;<br />    &lt;!-- dump coverage data, merge with server1, leaving dump-on-exit enabled: --&gt;<br />    &lt;command name="coverage.get" args="${dir.coverage}/coverage.ec, true, false"/&gt;<br />  &lt;/ctl&gt;<br />  &lt;report&gt;<br />    &lt;sourcepath&gt;<br />      &lt;!-- the source paths of all intrumented classes go here...--&gt;<br />    &lt;/sourcepath&gt;<br />    &lt;fileset dir="${dir.coverage}"&gt;<br />      &lt;include name="coverage.ec"/&gt;<br />      &lt;include name="coverage.em"/&gt;<br />    &lt;/fileset&gt;<br />    &lt;html outfile="${dir.coverage}/coverage.html"/&gt;<br />  &lt;/report&gt;<br />&lt;/emma&gt;<br /></pre></blockquote><br /><p>  A few notes:<br /><br />  </p><ul><br />    <li>If the server is restarted, the coverage data will get lost. To avoid this, leave "dump-on-exit" (the third <code>coverage.get</code> parameter) enabled and include the dumped serverside "coverage.ec" files in the report.</li><br />     <li>When redeploying the application, you must reset the coverage data (using the <code>coverage.reset</code> command) and delete the "coverage.ec" file from the server.</li><br />     <li>To reduce serverside memory usage, you may reset the coverage data after each <code>coverage.get</code>. In this case, you must always use "merge" mode when fetching new coverage data (the second <code>coverage.get</code> parameter)</li><br />  </ul><br />  </li><br /></ol><br /><div class="item_footer"><p><small><a href="http://bxm.at/blogs/java/webappliction_code_coverage">Original post</a> blogged on <a href="http://b2evolution.net/">b2evolution</a>.</small></p></div>